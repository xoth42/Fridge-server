name: ci

on:
  push:
  pull_request:

jobs:
  integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker sanity check
        run: |
          docker --version
          docker compose version

      - name: Start monitoring stack
        run: |
          # Bring up all core services in the background.
          docker compose up -d

      - name: Wait for Prometheus, Grafana and Pushgateway
        run: |
          # Poll readiness endpoints for all three services before running tests.
          for i in {1..30}; do
            PROM_OK=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:9090/-/ready || true)
            GRAF_OK=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/api/health || true)
            PUSH_OK=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:9091/-/healthy || true)
            if [ "$PROM_OK" = "200" ] && [ "$GRAF_OK" = "200" ] && [ "$PUSH_OK" = "200" ]; then
              echo "Prometheus, Grafana and Pushgateway are ready"
              exit 0
            fi
            sleep 2
          done
          echo "Timed out waiting for services" >&2
          docker compose ps
          exit 1

      - name: Push synthetic fridge metrics
        run: |
          python3 testdata/pushtestmetrics.py --pushgateway-url http://localhost:9091

      - name: Wait for Prometheus scrape
        run: |
          # Prometheus scrapes every 15s; sleep 16s to ensure the just-pushed
          # metrics are committed to the TSDB before querying.
          sleep 16

      - name: Verify Prometheus query API returns metric
        run: |
          RESPONSE=$(curl -sS 'http://localhost:9090/api/v1/query?query=fridgetestmetric')
          python3 testdata/check_prometheus_metric.py "$RESPONSE"

      - name: Verify Grafana provisioning
        run: |
          AUTH='admin:admin'
          DS=$(curl -sS -u "$AUTH" http://localhost:3000/api/datasources/name/Prometheus)
          python3 testdata/check_grafana_datasource.py "$DS"

          DASHES=$(curl -sS -u "$AUTH" 'http://localhost:3000/api/search?query=Fridge%20Test')
          python3 testdata/check_grafana_dashboard.py "$DASHES"

      - name: Tear down stack
        if: always()
        run: docker compose down
